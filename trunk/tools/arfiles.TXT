Sonic Unleashed AR format.

Nearly all files of Sonic Unleashed are LZW compressed. Thus if you wondered why
you can't even open DDS files - that's the reason. The LZW compression is a
Microsoft only compression which was modified for the Xbox 360. To uncompress
the files there are two tools you can use.

Either the quick but illegal way:
-acquire an Xbox 360 SDK and use xbdecompress.exe

usage would be:
-xbdecompress.exe [file] ([output file])
--> decompresses [file] - if no output file is given (or output directory) the
source file will be overwritten. Wildcards (xbdecompress.exe *.*) are okay! In
case you work with an extracted ISO (for JTAG consoles or such) do not worry,
you can safely overwrite the source files. Sonic Unleashed also accepts them
without LZW compression (also lowers loading times a bit ;) )! xbcompress.exe
which also ships with the SDK is thus useless - you'll need it if you burn
DVD+Rs though

Or the legal way (just the application is much slower)
-get yourself Quick BMS http://aluigi.org/papers.htm#quickbms
-and use that BMS module http://aluigi.org/papers/bms/xcompress_file.bms
--> uncompressing then works the following way:
    quickbms.exe xcompress_file.bms [source file]
    The file will be extracted wiht a new file name
    

Once the Sonic Unleashed files are extracted (feel free to just do 
"xbdecompress *.*" in all folders - it will save you much time) you can use
my two added tools (source code included in the source.zip file). ar0unpack.exe
will unpack a given ar file (or also ar.00/ar.01/ar.02) to the folder 
[input file].unpack --> so the command:

ar0unpack.exe shader.ar --> unpacks shader.ar to shader.ar.unpack\

Every unpacked folder contains a file called !archive-info.xml - DO NOT delete
this file (feel free to look at it). It contains package information about the
ar file - the packer (ar0create.exe) requires this file (it requires: the 4
header dwords, the filename attribute and the filenames in EXACTLY THAT ORDER
to put them back into an ar file as well as the unknown1 and unknown2 parameters
(I have no idea what they do but the game crashes if they are changed ) - thus
I repeat: DO NOT REORDER THE FILE LIST IN CASE YOU WANT ARCHIVES THAT SONIC
UNLEASHED CAN WORK WITH!!!).

Freely edit the unpacked files.. once you're done.. use ar0create.exe and point
it to the xml file:

ar0create.exe "shader\!archive-info.xml" --> creates a new shader.arc (note: the
file will be overwritten if it already exists!)

Files created with ar0create can be read by the game, they are fully
compatible!



Technical stuff: AR format

The AR format is Little endian (yes, you would expect Big Endian but well)
Each AR file begins with 4 32 bit integers. In most cases they are:

0x00000000: 00000000
0x00000004: 00000010 
0x00000008: 00000014 
0x0000000C: 00000040

In rare cases they change.. I do not really know what they do! They are stored
to !archive-info.xml during extraction. The a file segment begins:

[File segments]
File segments begin on any given address in an AR file.. they are not aligned!
They start with a little file header containing the following information (in
exactly that order - base address is the begin of a file segment):

Header:
0x00000000: Length of the complete file segment
0x00000004: Length of the file to unpack
0x00000008: Length of the header
0x0000000C: Unknown1 (stored to !archive-info.xml - shouldn't be changed)   
0x00000010: Unknown2 (stored to !archive-info.xml - shouldn't be changed)
0x00000014: File name as ASCII string null-terminated
After filename: a bunch of zeros - until the actual file starts - it fills each
header with 0s until the address in the AR file is a multiple of 0x00000040 .

File content:
uncompressed file data - length given in the header (position 0x00000004)